<!DOCTYPE html>
<html>
<head>
    <title>Universal Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            flex-direction: column;
        }

        .calculator-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 320px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        #display {
            grid-column: 1 / -1;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px;
            padding: 15px;
            font-size: 2.5em;
            text-align: right;
            color: #333;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
            box-sizing: border-box;
        }

        .button {
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px;
            padding: 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .button:hover {
            background-color: #d0d0d0;
        }

        .button.operator {
            background-color: #f8961e;
            color: #fff;
        }

        .button.operator:hover {
            background-color: #e0871b;
        }

        .button.equals {
            background-color: #28a745;
            color: #fff;
            grid-column: span 2;
        }

        .button.equals:hover {
            background-color: #218838;
        }

        .button.clear {
            background-color: #dc3545;
            color: #fff;
        }

        .button.clear:hover {
            background-color: #c82333;
        }

        .button.memory {
            background-color: #6c757d;
            color: #fff;
            font-size: 1.2em;
        }

        .button.memory:hover {
            background-color: #5a6268;
        }

        #history-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 320px;
            margin-top: 20px;
        }

        #history-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #555;
            text-align: center;
        }

        #history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        #history-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            color: #666;
        }

        #history-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div id="display">0</div>

        <button class="button clear" onclick="clearDisplay()">C</button>
        <button class="button memory" onclick="memoryRecall()">MR</button>
        <button class="button memory" onclick="memoryClear()">MC</button>
        <button class="button operator" onclick="appendOperator('/')">/</button>

        <button class="button" onclick="appendNumber('7')">7</button>
        <button class="button" onclick="appendNumber('8')">8</button>
        <button class="button" onclick="appendNumber('9')">9</button>
        <button class="button operator" onclick="appendOperator('*')">*</button>

        <button class="button" onclick="appendNumber('4')">4</button>
        <button class="button" onclick="appendNumber('5')">5</button>
        <button class="button" onclick="appendNumber('6')">6</button>
        <button class="button operator" onclick="appendOperator('-')">-</button>

        <button class="button" onclick="appendNumber('1')">1</button>
        <button class="button" onclick="appendNumber('2')">2</button>
        <button class="button" onclick="appendNumber('3')">3</button>
        <button class="button operator" onclick="appendOperator('+')">+</button>

        <button class="button memory" onclick="memoryAdd()">M+</button>
        <button class="button memory" onclick="memorySubtract()">M-</button>
        <button class="button" onclick="appendNumber('0')">0</button>
        <button class="button" onclick="appendDecimal()">.</button>
        <button class="button equals" onclick="calculateResult()">=</button>
    </div>

    <div id="history-container">
        <div id="history-title">Calculation History</div>
        <ul id="history-list">
        </ul>
    </div>

    <script>
        let displayValue = '0';
        let currentExpression = '';
        let memory = 0;
        let history = [];
        let awaitingNewInput = true;

        const displayElement = document.getElementById('display');
        const historyListElement = document.getElementById('history-list');

        function updateDisplay() {
            displayElement.textContent = displayValue;
        }

        function updateHistory() {
            historyListElement.innerHTML = '';
            history.slice(-5).reverse().forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                historyListElement.appendChild(li);
            });
        }

        function appendNumber(num) {
            if (awaitingNewInput) {
                displayValue = num;
                currentExpression = num;
                awaitingNewInput = false;
            } else {
                if (displayValue === '0' && num === '0') return;
                if (displayValue === '0' && num !== '0' && !currentExpression.match(/[\+\-\*\/]$/)) {
                    displayValue = num;
                    currentExpression = num;
                } else {
                    displayValue += num;
                    currentExpression += num;
                }
            }
            updateDisplay();
        }

        function appendOperator(op) {
            if (currentExpression === '' && op === '-') {
                currentExpression = '-';
                displayValue = '-';
                awaitingNewInput = false;
                updateDisplay();
                return;
            }
            
            if (currentExpression === '') return;

            const lastChar = currentExpression.slice(-1);
            if (['+', '-', '*', '/'].includes(lastChar)) {
                currentExpression = currentExpression.slice(0, -1) + op;
            } else {
                currentExpression += op;
            }
            awaitingNewInput = true;
            updateDisplay();
        }

        function appendDecimal() {
            if (awaitingNewInput) {
                displayValue = '0.';
                currentExpression += '0.';
                awaitingNewInput = false;
            } else {
                const lastSegmentMatch = currentExpression.match(/(\d+\.?\d*)$/);
                if (lastSegmentMatch && lastSegmentMatch[0].includes('.')) {
                    return;
                }
                if (['+', '-', '*', '/'].includes(currentExpression.slice(-1))) {
                    displayValue = '0.';
                    currentExpression += '0.';
                } else {
                    displayValue += '.';
                    currentExpression += '.';
                }
            }
            updateDisplay();
        }

        function clearDisplay() {
            displayValue = '0';
            currentExpression = '';
            awaitingNewInput = true;
            updateDisplay();
        }

        function tokenize(expression) {
            const tokens = [];
            let i = 0;
            while (i < expression.length) {
                let char = expression[i];

                if (/\d/.test(char) || (char === '.' && /\d/.test(expression[i + 1]))) {
                    let numStr = '';
                    while (i < expression.length && (/\d/.test(expression[i]) || expression[i] === '.')) {
                        numStr += expression[i];
                        i++;
                    }
                    tokens.push(parseFloat(numStr));
                    continue;
                }

                if (['+', '*', '/'].includes(char)) {
                    tokens.push(char);
                    i++;
                    continue;
                }

                if (char === '-') {
                    if (i === 0 || ['+', '-', '*', '/'].includes(expression[i - 1])) {
                        let numStr = '-';
                        i++;
                        if (i < expression.length && (/\d/.test(expression[i]) || expression[i] === '.')) {
                            while (i < expression.length && (/\d/.test(expression[i]) || expression[i] === '.')) {
                                numStr += expression[i];
                                i++;
                            }
                            tokens.push(parseFloat(numStr));
                            continue;
                        } else {
                            tokens.push('-');
                            continue;
                        }
                    } else {
                        tokens.push('-');
                        i++;
                        continue;
                    }
                }
                i++;
            }
            return tokens;
        }

        function evaluateTokens(tokens) {
            if (tokens.length === 0) return 0;
            if (tokens.length === 1 && typeof tokens[0] === 'number') return tokens[0];

            let tempTokens = [];
            for (let i = 0; i < tokens.length; i++) {
                const token = tokens[i];
                if (token === '*' || token === '/') {
                    const prevNum = tempTokens.pop();
                    const nextNum = tokens[++i];
                    if (typeof prevNum !== 'number' || typeof nextNum !== 'number') {
                        throw new Error("Invalid expression format");
                    }
                    if (token === '*') {
                        tempTokens.push(prevNum * nextNum);
                    } else {
                        if (nextNum === 0) throw new Error("Division by zero");
                        tempTokens.push(prevNum / nextNum);
                    }
                } else {
                    tempTokens.push(token);
                }
            }

            if (tempTokens.length === 0) return 0;
            if (tempTokens.length === 1 && typeof tempTokens[0] === 'number') return tempTokens[0];

            let result = parseFloat(tempTokens[0]);
            for (let i = 1; i < tempTokens.length; i += 2) {
                const operator = tempTokens[i];
                const nextNum = tempTokens[i + 1];
                if (typeof nextNum !== 'number') {
                    throw new Error("Invalid expression format");
                }
                if (operator === '+') {
                    result += nextNum;
                } else if (operator === '-') {
                    result -= nextNum;
                } else {
                    throw new Error("Invalid operator");
                }
            }
            return result;
        }

        function calculateResult() {
            if (currentExpression === '') return;

            try {
                const expressionToEvaluate = currentExpression;
                const tokens = tokenize(expressionToEvaluate);
                const result = evaluateTokens(tokens);
                
                history.push(`${expressionToEvaluate} = ${result}`);
                updateHistory();

                displayValue = result.toString();
                currentExpression = result.toString();
                awaitingNewInput = true;
            } catch (error) {
                displayValue = 'Error';
                currentExpression = '';
                awaitingNewInput = true;
            }
            updateDisplay();
        }

        function memoryAdd() {
            try {
                const value = parseFloat(displayValue);
                if (!isNaN(value)) {
                    memory += value;
                    history.push(`M+ ${value} (Memory: ${memory})`);
                    updateHistory();
                }
            } catch (error) {
                displayValue = 'Error';
                updateDisplay();
            }
        }

        function memorySubtract() {
            try {
                const value = parseFloat(displayValue);
                if (!isNaN(value)) {
                    memory -= value;
                    history.push(`M- ${value} (Memory: ${memory})`);
                    updateHistory();
                }
            } catch (error) {
                displayValue = 'Error';
                updateDisplay();
            }
        }

        function memoryRecall() {
            displayValue = memory.toString();
            currentExpression = memory.toString();
            awaitingNewInput = false;
            updateDisplay();
        }

        function memoryClear() {
            memory = 0;
            history.push(`MC (Memory cleared)`);
            updateHistory();
        }

        updateDisplay();
        updateHistory();
    </script>
</body>
</html>