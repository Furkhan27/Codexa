<!DOCTYPE html>
<html>
<head>
    <title>PrecisionCalc</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
        }
        .calculator {
            background-color: #282c34;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            padding: 20px;
            width: 320px;
            box-sizing: border-box;
        }
        #display {
            background-color: #4a4f59;
            color: #ffffff;
            font-size: 2.8em;
            text-align: right;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            height: 60px;
            line-height: 60px;
        }
        #buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        button {
            background-color: #61dafb;
            color: #282c34;
            border: none;
            border-radius: 10px;
            padding: 20px 0;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #21a1f1;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button.operator {
            background-color: #ff9500;
            color: #ffffff;
        }
        button.operator:hover {
            background-color: #e08000;
        }
        button.equals {
            background-color: #4CAF50;
            color: #ffffff;
            grid-column: span 2;
        }
        button.equals:hover {
            background-color: #45a049;
        }
        button.clear {
            background-color: #ff3b30;
            color: #ffffff;
        }
        button.clear:hover {
            background-color: #cc2d24;
        }
        button.all-clear {
            background-color: #ff3b30;
            color: #ffffff;
        }
        button.all-clear:hover {
            background-color: #cc2d24;
        }
        button.sign-change {
            background-color: #a2a2a2;
            color: #ffffff;
        }
        button.sign-change:hover {
            background-color: #8a8a8a;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div id="display">0</div>
        <div id="buttons">
            <button class="all-clear" data-value="AC">AC</button>
            <button class="clear" data-value="C">C</button>
            <button class="sign-change" data-value="+/-">+/-</button>
            <button class="operator" data-value="/">/</button>

            <button data-value="7">7</button>
            <button data-value="8">8</button>
            <button data-value="9">9</button>
            <button class="operator" data-value="*">*</button>

            <button data-value="4">4</button>
            <button data-value="5">5</button>
            <button data-value="6">6</button>
            <button class="operator" data-value="-">-</button>

            <button data-value="1">1</button>
            <button data-value="2">2</button>
            <button data-value="3">3</button>
            <button class="operator" data-value="+">+</button>

            <button data-value="0">0</button>
            <button data-value=".">.</button>
            <button class="equals" data-value="=">=</button>
        </div>
    </div>

    <script>
        let displayValue = '0';
        let currentExpression = '';

        const display = document.getElementById('display');
        const buttons = document.getElementById('buttons');

        const operate = (operator, a, b) => {
            a = parseFloat(a);
            b = parseFloat(b);
            if (isNaN(a) || isNaN(b)) throw new Error("Invalid number input");

            switch (operator) {
                case '+': return a + b;
                case '-': return a - b;
                case '*': return a * b;
                case '/':
                    if (b === 0) throw new Error("Division by zero");
                    return a / b;
                default: throw new Error("Unknown operator");
            }
        };

        const evaluate = (expression) => {
            if (!expression.trim()) return 0;

            const tokens = [];
            let match;
            const regex = /(-?\d+\.?\d*)|([+\-*/])/g;
            while ((match = regex.exec(expression)) !== null) {
                if (match[1]) {
                    tokens.push(parseFloat(match[1]));
                } else if (match[2]) {
                    tokens.push(match[2]);
                }
            }

            if (tokens.length === 0) return 0;
            if (typeof tokens[0] !== 'number' && tokens[0] !== '-') throw new Error("Malformed expression: starts with operator");
            if (typeof tokens[tokens.length - 1] !== 'number') throw new Error("Malformed expression: ends with operator");
            for (let i = 0; i < tokens.length - 1; i++) {
                if (typeof tokens[i] !== 'number' && typeof tokens[i+1] !== 'number') {
                    throw new Error("Malformed expression: consecutive operators");
                }
            }

            for (let i = 0; i < tokens.length; i++) {
                const token = tokens[i];
                if (token === '*' || token === '/') {
                    const prev = tokens[i - 1];
                    const next = tokens[i + 1];
                    if (typeof prev !== 'number' || typeof next !== 'number') throw new Error("Malformed expression");

                    const result = operate(token, prev, next);
                    tokens.splice(i - 1, 3, result);
                    i -= 2;
                }
            }

            let result = tokens[0];
            for (let i = 1; i < tokens.length; i += 2) {
                const operator = tokens[i];
                const operand = tokens[i + 1];
                if (typeof result !== 'number' || typeof operand !== 'number') throw new Error("Malformed expression");

                result = operate(operator, result, operand);
            }

            if (isNaN(result)) throw new Error("Invalid calculation result");
            return result;
        };

        buttons.addEventListener('click', (event) => {
            const target = event.target;
            if (!target.matches('button')) return;

            const buttonValue = target.dataset.value;

            if ('0123456789'.includes(buttonValue)) {
                if (displayValue === '0' || displayValue === 'Error' || '+-*/'.includes(displayValue)) {
                    displayValue = buttonValue;
                    currentExpression = buttonValue;
                } else {
                    displayValue += buttonValue;
                    currentExpression += buttonValue;
                }
            } else if (buttonValue === '.') {
                const lastNumMatch = currentExpression.match(/(-?\d+\.?\d*)$/);
                if (lastNumMatch && lastNumMatch[0].includes('.')) {
                } else {
                    if (displayValue === '0' || displayValue === 'Error' || '+-*/'.includes(displayValue)) {
                        displayValue = '0.';
                        currentExpression += '0.';
                    } else {
                        displayValue += '.';
                        currentExpression += '.';
                    }
                }
            } else if ('+-*/'.includes(buttonValue)) {
                if (displayValue === 'Error') {
                    currentExpression = '0';
                    displayValue = '0';
                }
                const lastChar = currentExpression[currentExpression.length - 1];
                if ('+-*/'.includes(lastChar)) {
                    currentExpression = currentExpression.slice(0, -1) + buttonValue;
                } else {
                    currentExpression += buttonValue;
                }
                displayValue = buttonValue;
            } else if (buttonValue === '=') {
                try {
                    const result = evaluate(currentExpression);
                    displayValue = result.toString();
                    currentExpression = result.toString();
                } catch (e) {
                    displayValue = 'Error';
                    currentExpression = '';
                }
            } else if (buttonValue === 'AC') {
                displayValue = '0';
                currentExpression = '';
            } else if (buttonValue === 'C') {
                if (displayValue === 'Error') {
                    displayValue = '0';
                    currentExpression = '';
                } else if (currentExpression.length > 0) {
                    currentExpression = currentExpression.slice(0, -1);
                    if (currentExpression === '') {
                        displayValue = '0';
                    } else {
                        const lastPartMatch = currentExpression.match(/(-?\d+\.?\d*|[+\-*/])$/);
                        displayValue = lastPartMatch ? lastPartMatch[0] : '0';
                    }
                } else {
                    displayValue = '0';
                }
            } else if (buttonValue === '+/-') {
                const lastNumMatch = currentExpression.match(/(-?\d+\.?\d*)$/);
                if (lastNumMatch) {
                    const lastNum = parseFloat(lastNumMatch[0]);
                    const newNum = (-lastNum).toString();
                    currentExpression = currentExpression.slice(0, -lastNumMatch[0].length) + newNum;
                    displayValue = newNum;
                } else if (currentExpression === '' || currentExpression === '0') {
                    currentExpression = '-0';
                    displayValue = '-0';
                }
            }
            display.textContent = displayValue;
        });

        display.textContent = displayValue;
    </script>
</body>
</html>