<!DOCTYPE html>
<html>
<head>
    <title>The Universal Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        #calculator {
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 320px;
            background-color: #fff;
            padding: 20px;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 10px;
        }

        #display-history {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9em;
            color: #666;
            min-height: 20px;
            text-align: right;
            overflow-x: auto;
            white-space: nowrap;
        }

        #display-current {
            background-color: #34495e;
            color: #ecf0f1;
            border-radius: 5px;
            padding: 15px;
            font-size: 2.5em;
            text-align: right;
            min-height: 40px;
            overflow-x: auto;
            white-space: nowrap;
            margin-bottom: 10px;
        }

        #buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .button {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 20px 0;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .button:hover {
            background-color: #e2e6ea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .button:active {
            background-color: #dae0e5;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .button.operator {
            background-color: #e74c3c;
            color: #fff;
        }

        .button.operator:hover {
            background-color: #c0392b;
        }

        .button.operator:active {
            background-color: #a93226;
        }

        .button.clear {
            background-color: #f39c12;
            color: #fff;
        }

        .button.clear:hover {
            background-color: #e67e22;
        }

        .button.clear:active {
            background-color: #d35400;
        }

        .button.equals {
            background-color: #2ecc71;
            color: #fff;
            grid-column: span 2;
        }

        .button.equals:hover {
            background-color: #27ae60;
        }

        .button.equals:active {
            background-color: #229954;
        }
    </style>
</head>
<body>
    <h1>The Universal Calculator</h1>
    <div id="calculator">
        <div id="display-history"></div>
        <div id="display-current">0</div>
        <div id="buttons">
            <div class="button clear" data-value="C">C</div>
            <div class="button operator" data-value="(">(</div>
            <div class="button operator" data-value=")">)</div>
            <div class="button operator" data-value="/">/</div>

            <div class="button" data-value="7">7</div>
            <div class="button" data-value="8">8</div>
            <div class="button" data-value="9">9</div>
            <div class="button operator" data-value="*">*</div>

            <div class="button" data-value="4">4</div>
            <div class="button" data-value="5">5</div>
            <div class="button" data-value="6">6</div>
            <div class="button operator" data-value="-">-</div>

            <div class="button" data-value="1">1</div>
            <div class="button" data-value="2">2</div>
            <div class="button" data-value="3">3</div>
            <div class="button operator" data-value="+">+</div>

            <div class="button" data-value="0">0</div>
            <div class="button" data-value=".">.</div>
            <div class="button equals" data-value="=">=</div>
        </div>
    </div>

    <script>
        let currentInput = '';
        let currentResult = '';
        let historyDisplay;
        let currentDisplay;

        function add(a, b) { return a + b; }
        function subtract(a, b) { return a - b; }
        function multiply(a, b) { return a * b; }
        function divide(a, b) {
            if (b === 0) throw new Error("Division by zero");
            return a / b;
        }

        const precedence = {
            '+': 1,
            '-': 1,
            '*': 2,
            '/': 2
        };

        function isOperator(token) { return ['+', '-', '*', '/'].includes(token); }
        function isNumber(token) { return !isNaN(parseFloat(token)) && isFinite(token); }

        function tokenize(expression) {
            const tokenRegex = /(\d+\.?\d*|\.\d+|[+\-*/()])/g;
            const tokens = expression.match(tokenRegex);
            if (!tokens) return [];

            const processedTokens = [];
            for (let i = 0; i < tokens.length; i++) {
                let token = tokens[i];
                if (token === '-' && (i === 0 || ['(', '+', '-', '*', '/'].includes(tokens[i-1]))) {
                    if (i + 1 < tokens.length && isNumber(tokens[i+1])) {
                        processedTokens.push(token + tokens[i+1]);
                        i++;
                    } else {
                        processedTokens.push(token);
                    }
                } else {
                    processedTokens.push(token);
                }
            }
            return processedTokens;
        }

        function shuntingYard(infixTokens) {
            const outputQueue = [];
            const operatorStack = [];

            for (const token of infixTokens) {
                if (isNumber(token)) {
                    outputQueue.push(parseFloat(token));
                } else if (isOperator(token)) {
                    while (
                        operatorStack.length > 0 &&
                        isOperator(operatorStack[operatorStack.length - 1]) &&
                        precedence[operatorStack[operatorStack.length - 1]] >= precedence[token]
                    ) {
                        outputQueue.push(operatorStack.pop());
                    }
                    operatorStack.push(token);
                } else if (token === '(') {
                    operatorStack.push(token);
                } else if (token === ')') {
                    while (operatorStack.length > 0 && operatorStack[operatorStack.length - 1] !== '(') {
                        outputQueue.push(operatorStack.pop());
                    }
                    if (operatorStack.length === 0 || operatorStack[operatorStack.length - 1] !== '(') {
                        throw new Error("Mismatched parentheses");
                    }
                    operatorStack.pop();
                }
            }

            while (operatorStack.length > 0) {
                const op = operatorStack.pop();
                if (op === '(' || op === ')') {
                    throw new Error("Mismatched parentheses");
                }
                outputQueue.push(op);
            }
            return outputQueue;
        }

        function evaluatePostfix(postfixTokens) {
            const stack = [];
            for (const token of postfixTokens) {
                if (isNumber(token)) {
                    stack.push(token);
                } else if (isOperator(token)) {
                    if (stack.length < 2) throw new Error("Invalid expression");
                    const b = stack.pop();
                    const a = stack.pop();
                    let result;
                    switch (token) {
                        case '+': result = add(a, b); break;
                        case '-': result = subtract(a, b); break;
                        case '*': result = multiply(a, b); break;
                        case '/': result = divide(a, b); break;
                    }
                    stack.push(result);
                }
            }
            if (stack.length !== 1) throw new Error("Invalid expression");
            return stack.pop();
        }

        function calculateExpression(expression) {
            if (!expression) return '';
            try {
                const tokens = tokenize(expression);
                const postfix = shuntingYard(tokens);
                const result = evaluatePostfix(postfix);
                return result;
            } catch (error) {
                return 'Error: ' + error.message;
            }
        }

        function updateDisplay() {
            historyDisplay.textContent = currentInput;
            if (currentResult) {
                currentDisplay.textContent = currentResult;
            } else {
                currentDisplay.textContent = currentInput || '0';
            }
        }

        function appendInput(value) {
            if (currentResult && (isNumber(value) || value === '.')) {
                currentInput = value;
                currentResult = '';
            } else if (currentResult && isOperator(value)) {
                currentInput = String(currentResult) + value;
                currentResult = '';
            } else {
                if (currentInput === '0' && value !== '.' && isNumber(value)) {
                    currentInput = value;
                } else {
                    currentInput += value;
                }
            }
            updateDisplay();
        }

        function clearAll() {
            currentInput = '';
            currentResult = '';
            updateDisplay();
        }

        function calculate() {
            if (!currentInput) return;
            const result = calculateExpression(currentInput);
            if (String(result).startsWith('Error')) {
                currentResult = result;
                currentInput = '';
            } else {
                currentResult = result;
                currentInput = String(result);
            }
            updateDisplay();
        }

        function runArithmeticTests() {
            if (add(1, 2) !== 3) throw new Error("Add test failed: 1+2");
            if (add(-1, 1) !== 0) throw new Error("Add test failed: -1+1");
            if (subtract(5, 2) !== 3) throw new Error("Subtract test failed: 5-2");
            if (subtract(2, 5) !== -3) throw new Error("Subtract test failed: 2-5");
            if (multiply(2, 3) !== 6) throw new Error("Multiply test failed: 2*3");
            if (multiply(-2, 3) !== -6) throw new Error("Multiply test failed: -2*3");
            if (divide(6, 3) !== 2) throw new Error("Divide test failed: 6/3");
            try { divide(1, 0); throw new Error("Divide by zero test failed: 1/0 did not throw"); } catch (e) { if (e.message !== "Division by zero") throw e; }
            if (calculateExpression("2+3*4") !== 14) throw new Error("Precedence test failed: 2+3*4");
            if (calculateExpression("(2+3)*4") !== 20) throw new Error("Parentheses test failed: (2+3)*4");
            if (calculateExpression("10/2-1") !== 4) throw new Error("Precedence test failed: 10/2-1");
            if (calculateExpression("1.5+2.5") !== 4) throw new Error("Decimal test failed: 1.5+2.5");
            if (calculateExpression("abc") !== 'Error: Invalid character in expression') throw new Error("Invalid input test failed: abc");
            if (calculateExpression("5/0") !== 'Error: Division by zero') throw new Error("Division by zero test failed: 5/0");
            if (calculateExpression("2*-3") !== -6) throw new Error("Unary minus test failed: 2*-3");
            if (calculateExpression("(-3)+5") !== 2) throw new Error("Parenthesized unary minus test failed: (-3)+5");
        }

        document.addEventListener('DOMContentLoaded', () => {
            historyDisplay = document.getElementById('display-history');
            currentDisplay = document.getElementById('display-current');

            document.querySelectorAll('.button').forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value;
                    if (value === 'C') {
                        clearAll();
                    } else if (value === '=') {
                        calculate();
                    } else {
                        appendInput(value);
                    }
                });
            });

            updateDisplay();
        });
    </script>
</body>
</html>